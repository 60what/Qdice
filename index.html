<!DOCTYPE html>
<html>
<head>

<title>Quick Dice</title>

<link rel="icon" type="image/png" href="./icon192.png">
<link rel="apple-touch-icon" href="./icon192.png">

<link rel="manifest" href="./qdice.webmanifest"/>

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />



<style>



	/* global color variables */
:root {
  --red: #c32;
  --yel: #ec3;
  --grn: #284;
  --blu: #35b;

  --tan: #cba;
  --oat: #a98;
  --brn: #876;

  --prl: #eee;
  --gry: #999;
  --drk: #222;

  --mst: rgba(255, 255, 255, .15);
  --fog: rgba(255, 255, 255, .5);
}

@font-face { font-family: 'Roboto-Black'; src: url('./Roboto-Black.ttf') format('truetype'); }
@font-face { font-family: 'Verdana-Bold'; src: url('./Verdana-Bold.ttf') format('truetype'); }

html, body { width: 100%; height: 100%; }

body {
  overscroll-behavior-y: contain;
  overflow: hidden;
  margin: 0;
  background-image: repeating-linear-gradient(-45deg, var(--oat) 0 8%, var(--tan) 0 50%);
  background-size: 12px 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: 'Verdana-Bold', sans-serif;
}

.page1 {
  position: absolute;
  width: 9em;
  height: 16em;
  transform-origin: 4.5em 8em;
}

	/* ------------------------------------------------------------- */
	/* scorecard starts left of the screen with a sliding transition */
.card {
  color: var(--fog);
  font-family: 'Roboto-Black', sans-serif;
  position: absolute;
  width: 9em; height: 16em;
  right: 50vmin; margin-right: 4.5em;  /* left edge of the screen */
  transition-property: right, margin;
  background-color: currentColor;
}

.bar { width: 1.4em; position: absolute; background-color: currentColor; }

.tile {
  position: relative;
  width: 1.2em; height: 1.2em; margin: .1em;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: .2em;
}

.tile > span {
  font-size: 80%;
  width: 88%; height: 88%;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 14%;
}



.score.bar { height: 15.8em; padding: .2em 0 0 0;
                          right: 2.0em; color: var(--red); }
.score.bar:nth-child(2) { right: 3.4em; color: var(--yel); }
.score.bar:nth-child(3) { right: 4.8em; color: var(--grn); }
.score.bar:nth-child(4) { right: 6.2em; color: var(--blu); }

.score > .tile     { background-color: var(--fog); }
.score > .tile_off { background-color: var(--mst); }

.score > .tile_sel { background-color: white !important; }
.score > .tile_sel > span { background-color: currentColor; }
.score > .tile_sel > span > span { color: white !important; }

.lock, .lock > span { border-radius: 50%; }
.lock > span > span { opacity: 0; }

.score.locked_bar > .tile          { background-color: var(--mst); }
.score.locked_bar > .lock.tile_off { background-color: var(--fog); }
.score.locked_bar > .tile_sel           { opacity: .7; }
.score.locked_bar > .tile:nth-child(11) { opacity: 1; }
.score.locked_bar > .lock > span > span { opacity: 1; }



.penalty.bar { top: 9.3em; right: 7.6em; color: transparent; }
.penalty > .tile { color: var(--gry); background-color: currentColor; }
.penalty > .tile > span { background-color: var(--prl); font-size: 38%; }
.penalty > .tile_sel { color: var(--drk); }



.points.bar { right: 7.6em; color: transparent; }

.points > .tile { margin: .06em .1em .06em .1em;
                               color: var(--drk); }
.points > .tile:nth-child(1) { color: var(--red); }
.points > .tile:nth-child(2) { color: var(--yel); }
.points > .tile:nth-child(3) { color: var(--grn); }
.points > .tile:nth-child(4) { color: var(--blu); }
.points > .tile:nth-child(5) { color: var(--gry); }

.points > .tile:nth-child(n + 6) { opacity: 0; transition: opacity .5s !important; }

.points > .tile > span {
  font-size: .5em;
  width: 2.2em; height: 1.6em;
  border: .1em solid currentColor;
  border-radius: .4em;
  background-color: var(--prl);
}

.points > .tile:nth-child(6) > span {
  font-size: .3em;
  text-align: center;
  border: 0;
  background: none;
}

/* ------------------------------------------------------------ */

.dice_mat {
  position: absolute;
  background-color: var(--drk);
  border-radius: .33em;
  box-shadow: 0 0 .33em black;
  width: 7em;
  height: 10em;
  margin: 1em 0 0 1em;
}

	/* dice are set to white by defualt */
.dice {
  background-image: radial-gradient(white 70%, black 115%);
  border-radius: .12em;
  position: absolute;
  display:flex;
  align-items: center;
  justify-content: center;
  visibility: visible;
  margin: 1em 0 0 1em;
  transition: margin 0s ease-out;
  width: 2em;
  height: 2em;
  top: 0;
  left: 0;
}

.dice:nth-child(2n + 2) { left: 3em; }

	/* the first 2 dice remain white, the rest are colored */
.dice:nth-child(4n + 3) { top: 3em; background-image: radial-gradient(var(--red) 70%, black 115%); }
.dice:nth-child(4n + 4) { top: 3em; background-image: radial-gradient(var(--yel) 70%, black 115%); }
.dice:nth-child(4n + 5) { top: 6em; background-image: radial-gradient(var(--grn) 70%, black 115%); }
.dice:nth-child(4n + 6) { top: 6em; background-image: radial-gradient(var(--blu) 70%, black 115%); }

	/* the 4 ghost dice are transparent and start hidden */
.dice:nth-child(n + 7) {
  opacity: 0.3;
  display: none;
  visibility: inherit;  /* visibility copies the dice mat */
}

	/* pips start hidden and are set to black by defualt */
.dice > div { 
  position: absolute;
  background-image: radial-gradient(closest-side, black 80%, transparent);
  width: 18%;
  height: 18%;
  visibility: hidden;
}

	/* pips on the 3rd and following dice are set to white */
.dice:nth-child(n + 3) > div { background-image: radial-gradient(closest-side, white 80%, transparent); }

	/* position the 7 possible pips on the faces of the dice */
.dice div { top: 41%; left: 18%; }
.dice div:nth-child(1) { top: 18%; }
.dice div:nth-child(2) { top: 18%; left: 64%; }
.dice div:nth-child(4) { left: 41%; }
.dice div:nth-child(5) { left: 64%; }
.dice div:nth-child(6) { top: 64%; }
.dice div:nth-child(7) { top: 64%; left: 64%; }


	/* numerals start hidden and are set to black by default */
.numeral {
  color: black;
  font-size: 150%;
  background-color: white;

  width: 68%;
  height: 68%;
  z-index: 1;
  opacity: 0;
  margin: auto;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: opacity .5s;
  font-family: 'Roboto-Black', sans-serif;
}

	/* numerals on the 3rd and following dice are set to white */
.dice:nth-child(n + 3) > span { color: white; }
.dice:nth-child(3) > span { background-color: var(--red); }
.dice:nth-child(4) > span { background-color: var(--yel); }
.dice:nth-child(5) > span { background-color: var(--grn); }
.dice:nth-child(6) > span { background-color: var(--blu); }

	/* some button features are set relative to the font size */
.buttn {
  color: var(--drk);
  font-size: 125%;
  text-shadow: 0 .03em .05em var(--tan);

  position: absolute;
  background-image: linear-gradient(var(--oat) 0, var(--brn) 100%);
  width: 1.84em;
  height: 1.84em;
  border-radius: .3em;
  border: .08em solid var(--drk);
  margin: 9.333em 0 0 .333em;
  text-align: center;
  left: 3.533em;
}

.shake { left: 1em; }
.shake:active { opacity: 0.3; }

.buttn div { font-size: 40%; }



</style>



</head>
<body oncontextmenu="return false;" onselectstart="return false;"">

<!---
<span onclick="document.getElementById('page1').style.visibility = 'hidden';">hide all but dice</span>
<span onclick="document.getElementById('page1').style.visibility = 'visible';">- come back</span>
<br>
<span onclick="document.getElementById('page1').style.display = 'none';">hide all</span>
<span onclick="document.getElementById('page1').style.display = 'inline';">- come back</span>
--->

<div id="page1" class="page1">

  <div id="mat" style="transition: opacity .5s;">
  <div id="dice_mat" class="dice_mat">

    <div class="dice">
      <div></div><div></div><div></div><div></div><div></div><div></div><div></div>
      <span class="numeral"></span>
    </div>

    <div class="dice">
      <div></div><div></div><div></div><div></div><div></div><div></div><div></div>
      <span class="numeral"></span>
    </div>

    <div class="dice" onclick="in_out(2, 0);">
      <div></div><div></div><div></div><div></div><div></div><div></div><div></div>
      <span class="numeral"></span>
    </div>

    <div class="dice" onclick="in_out(3, 0);">
      <div></div><div></div><div></div><div></div><div></div><div></div><div></div>
      <span class="numeral"></span>
    </div>

    <div class="dice" onclick="in_out(4, 0);">
      <div></div><div></div><div></div><div></div><div></div><div></div><div></div>
      <span class="numeral"></span>
    </div>

    <div class="dice" onclick="in_out(5, 0);">
      <div></div><div></div><div></div><div></div><div></div><div></div><div></div>
      <span class="numeral"></span>
    </div>

    <div class="dice" onclick="in_out(6, 0);"></div>
    <div class="dice" onclick="in_out(7, 0);"></div>
    <div class="dice" onclick="in_out(8, 0);"></div>
    <div class="dice" onclick="in_out(9, 0);"></div>

  </div>

  <div id="shake" class="buttn shake" onclick="shaker();">
    S
    <div>
      SHAKE
    </div>
  </div>

  <div id="roll" class="buttn" style="opacity: 0.3;" onclick="roller();">
    R
    <div>
      ROLL
    </div>
  </div>
  </div>

  <div onclick="toggle_scorecard();" style="position: absolute; bottom: 0; z-index: 1; visibility: visible;">+</div>
  <div onclick="toggle_faces();" style="position: absolute; bottom: 0; right: 0; z-index: 1; visibility: visible;">#</div>

  <div id="card" class="card">
    <div class="score bar"></div>
    <div class="score bar"></div>
    <div class="score bar"></div>
    <div class="score bar"></div>
    <div class="penalty bar"></div>
    <div class="points bar"></div>
  </div>

</div>



<script type="text/javascript">



  var landscape;

  var seed = -1;  /* indicates dice not shaken yet */
  var dice_locked = new Array(5).fill(0);  /* dice locked by card selections */
  var use_numerals = 0;  /* pips are displayed by defualt */
  var shake_count = 0;

  var scorecard = 0;

  var undo = 1;
  var consume = 0;

  var game_end = 0;



  window.onload = populate();

  function populate() {

    let s = document.querySelectorAll('.score');
    for (let i = 0; i < 4; i++) {
      for (let j = 0; j < 12; j++) {
        s[i].appendChild(document.createElement('div'));
        s[i].children[j].className = 'tile' + (j == 10 ? ' tile_off' : '');
        s[i].children[j].setAttribute('onclick','toggle_tile(' + i + ', ' + j + ');');
        s[i].children[j].appendChild(document.createElement('span'));
        s[i].children[j].children[0].appendChild(document.createElement('span'));
        s[i].children[j].children[0].children[0].innerText = (i < 2 ? j + 2 : 12 - j);
      }
      s[i].children[11].className += ' lock';
      s[i].children[11].children[0].children[0].innerText = 'X';
      s[i].children[11].setAttribute('onclick','toggle_lock(' + i + ', 0);');
    }

    let p = document.querySelector('.penalty');
    for (let i = 0; i < 4; i++) {
      p.appendChild(document.createElement('div'));
      p.children[i].className = 'tile';
      p.children[i].setAttribute('onclick','toggle_penalty(' + i + ');');
      p.children[i].appendChild(document.createElement('span'));
      p.children[i].children[0].appendChild(document.createElement('span'));
      p.children[i].children[0].children[0].innerText = 'PASS';
    }

    let t = document.querySelector('.points');
    for (let i = 0; i < 7; i++) {
      t.appendChild(document.createElement('div'));
      t.children[i].className = 'tile';
      t.children[i].appendChild(document.createElement('span'));
      t.children[i].children[0].innerText = (i < 4 ? '+ 0' : i < 5 ? '- 0' : 'TOTAL SCORE:');
    }

  }



  new ResizeObserver(() => {

    draw_page1();

  }).observe(document.body);



  function draw_page1() {

    let rotated = 0;
    let pg = document.getElementById('page1').style;

	/* determine orientation and scale from screen dimensions */

    if (window.innerHeight < window.innerWidth) {
      if (window.innerHeight * 16 < window.innerWidth * 9) {
        pg.fontSize = window.innerHeight / 9 + 'px';
      } else {
        pg.fontSize = window.innerWidth / 16 + 'px';
      }
      if (!landscape) rotated = 1;
      landscape = 1;

    } else {

      if (window.innerHeight * 9 > window.innerWidth * 16) {
        pg.fontSize = window.innerWidth / 9 + 'px';
      } else {
        pg.fontSize = window.innerHeight / 16 + 'px';
      }
      if (landscape) rotated = 1;
      landscape = 0;
    }

    if (rotated) {
      pg.transform = landscape ? 'rotate(-90deg)' : 'rotate(0deg)';
      let flip = document.querySelectorAll('.dice, .buttn, .tile');

      for (let i = 0; i < flip.length; i++) {
        flip[i].style.transitionDuration = '0s'; // for jiggled dice
        flip[i].style.transform = landscape ? 'rotate(90deg)' : 'rotate(0deg)';
      }
    }

	/* these prevent ghosting on the left edge */
    document.getElementById('card').style.transitionDuration = '0s';
    if (!scorecard) document.getElementById('card').style.visibility = 'hidden';

  }



  function in_out(i, source) {

	/* up to 2 colored dice can be toggled in or out */

    if (i < 6 && game_end) return;
    if (i > 5 && (dice_locked[4] || dice_locked[i - 6])) return;

    let j = (i < 6 ? 1 : -1);

    let mat = document.getElementById('dice_mat');
    mat.children[i].style.display = 'none';
    mat.children[i + 4 * j].style.display = 'flex';

    if (source < 1) toggle_lock(((i - 2) % 4), 2);

  }



  function toggle_faces() {

    use_numerals = !use_numerals;
    let d = document.querySelectorAll('.dice');
    for (let i = 0; i < 6; i++) {
      d[i].children[7].style.opacity = 0 + use_numerals;
    }

  }



  function toggle_scorecard() {

    let d = document.getElementById('card').style;
    d.transitionDuration = '.5s';

    if (scorecard) {
      d.marginRight = '4.5em'; d.right = '50vmin';

      document.getElementById('mat').style.opacity = '1';
    } else {
      d.visibility = 'visible'; d.margin = d.right = 0;

      document.getElementById('mat').style.opacity = '0';
    }
    scorecard = !scorecard;

  }



  function toggle_tile(bar, tile) {

    if (dice_locked[4]) return;

    let b = document.getElementById('card').children[bar];
    let t = b.children[tile].classList;

    if (b.classList.contains('locked_bar') && (tile < 10 || !t.contains('tile_sel'))) return;
    if (t.contains('tile_off')) return;
    if (t.contains('tile_sel') && undo < 1) return;

    if (tile > 9) { dice_locked[bar] = !dice_locked[bar]; toggle_lock(bar, 1); }

    if (t.contains('tile_sel')) {

      t.remove('tile_sel'); undo -= consume;

      while (tile > 0) {
        tile--; b.children[tile].classList.remove('tile_off');
        if (b.children[tile].classList.contains('tile_sel')) tile = 0;
      }

      if (b.querySelectorAll('.tile_sel').length < 5) {
        b.children[10].classList.add('tile_off');
      }
    } else {

      t.add('tile_sel');

      while (tile > 0) {
        tile--; b.children[tile].classList.add('tile_off');
        if (b.children[tile].classList.contains('tile_sel')) tile = 0;
      }

      if (b.querySelectorAll('.tile_sel').length > 4) {
        b.children[10].classList.remove('tile_off');
      }
    }

  update_points();
  }



  function toggle_lock(bar, source) {

    let c = document.getElementById('card');
    let s = c.children[bar].children[11].classList;

    if (c.children[bar].classList.contains('locked_bar') && !s.contains('tile_off')) return;
    if (s.contains('tile_off') && undo < 1 && source < 2) return;
    if (s.contains('tile_sel') && !source) return;

    if (s.contains('tile_off')) {

      s.remove('tile_off', 'tile_sel');

      game_end = 0; if (!source) undo -= consume;
      if (source < 2) in_out(bar + 6, 1);

      for (let j = 0; j < 5; j++) {
        if (!c.children[j].lastChild.classList.contains('tile_off')) {
          c.children[j].classList.remove('locked_bar');
        }
      }
    } else {

      s.add('tile_off'); if (source == 1) s.add('tile_sel');
      if (source < 2) in_out(bar + 2, 1);
      c.children[bar].classList.add('locked_bar');

      if (document.querySelectorAll('.locked_bar').length > 1) {
        game_end = 1;
        for (let j = 0; j < 5; j++) c.children[j].classList.add('locked_bar');
      }
    }

  update_points();
  }



  function toggle_penalty(i) {

    let p = document.querySelector('.penalty');
    let c = document.getElementById('card');

    if (p.classList.contains('locked_bar')) return;
    if (p.children[i].classList.contains('tile_sel') && undo < 1) return;

    let k = p.querySelectorAll('.tile_sel').length;

    if (p.children[i].classList.contains('tile_sel')) {

      p.children[k - 1].classList.remove('tile_sel');
      dice_locked[4] = game_end = 0; undo -= consume;

      for (let j = 0; j < 4; j++) {
        if (!c.children[j].lastChild.classList.contains('tile_off')) {
          c.children[j].classList.remove('locked_bar');
        }
      }
    } else {

      p.children[k].classList.add('tile_sel');

      if (k > 2) {
        dice_locked[4] = game_end = 1;
        for (let j = 0; j < 4; j++) c.children[j].classList.add('locked_bar');
      }
    }

  update_points();
  }



  function update_points() {

    let c = document.getElementById('card');
    let p = document.querySelector('.points');

    let i = -5 * c.children[4].querySelectorAll('.tile_sel').length;
    p.children[4].children[0].textContent = '- ' + (i * -1);

    for (let j = 0; j < 4; j++) {
      let k = c.children[j].querySelectorAll('.tile_sel').length;
      let r = 0; while (k > 0) r += k--;
      p.children[j].children[0].textContent = '+ ' + r; i += r;
    }

    p.children[6].children[0].textContent = i;

    p.children[5].style.opacity = p.children[6].style.opacity = game_end;

  }



  function shaker() {

	/* if not yet shaken, blank the dice */

    if (seed < 0) {
      for (let i = 0; i < 6; i++) {

        let d = document.getElementById('dice_mat').children[i];
        d.children[7].textContent = '';

        for (let j = 0; j < 7; j++) {
          d.children[j].style.visibility = 'hidden';
        }
      }
      seed = 0;
      document.getElementById('roll').style.opacity = 1.0;
    }

	/* each shake is added to the previous */

    shake_count++;
    let hashes = xmur3(String(Date.now() / shake_count));
    let rand = sfc32(hashes(), hashes(), hashes(), hashes());
    seed = (seed + rand()) % 1;

	/* shaking the dice jiggles them */

    jiggle(.2);

  }



  function jiggle(anim) {

    for (let i = 0; i < 6 ; i++) {
      let d = document.getElementById('dice_mat').children[i].style;

      d.transitionDuration = anim + 's';
      d.marginTop = .55 + .9 * Math.random() + 'em';
      d.marginLeft = .55 + .9 * Math.random() + 'em';
    }

  }



  function reveal_face(i, j) {

    let d = document.getElementById('dice_mat').children[i];
    d.children[7].textContent = (j + 1);

    if (j % 2 == 0) {
      d.children[3].style.visibility = 'visible';
    }
    if (j != 0) {
      d.children[1].style.visibility = 'visible';
      d.children[5].style.visibility = 'visible';
    }
    if (j > 2) {
      d.children[0].style.visibility = 'visible';
      d.children[6].style.visibility = 'visible';
    }
    if (j > 4) {
      d.children[2].style.visibility = 'visible';
      d.children[4].style.visibility = 'visible';
    }

  }



  function roller() {

	/* dice won't be rolled if not yet shaken */

    if (seed < 0) return;

	/* parse the rolls, display each and remove jiggle */

    let rolled = Math.floor(seed * (6 ** 6)).toString(6).padStart(6, '0');
    
    for (let i = 0; i < 6; i++) {
      reveal_face(i, parseInt(rolled.charAt(5 - i)));
      document.getElementById('dice_mat').children[i].style.margin = '1em 0 0 1em';
    }

	/* disable the roll button until dice are shaken again */

    seed = -1;
    document.getElementById('roll').style.opacity = .3;

  }



/* -------------------------------------
   not my code: MurmurHash3 + sfc32 PRNG
   ------------------------------------- */



function xmur3(str) {
    for(var i = 0, h = 1779033703 ^ str.length; i < str.length; i++) {
        h = Math.imul(h ^ str.charCodeAt(i), 3432918353);
        h = h << 13 | h >>> 19;
    } return function() {
        h = Math.imul(h ^ (h >>> 16), 2246822507);
        h = Math.imul(h ^ (h >>> 13), 3266489909);
        return (h ^= h >>> 16) >>> 0;
    }
}



function sfc32(a, b, c, d) {
    return function() {
      a >>>= 0; b >>>= 0; c >>>= 0; d >>>= 0; 
      var t = (a + b) | 0;
      a = b ^ b >>> 9;
      b = c + (c << 3) | 0;
      c = (c << 21 | c >>> 11);
      d = d + 1 | 0;
      t = t + d | 0;
      c = c + t | 0;
      return (t >>> 0) / 4294967296;
    }
}



/* -------------------------------------
   register a service worker for offline
   ------------------------------------- */



if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./service-worker.js');
}



</script>
</body>
</html>
