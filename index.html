<!DOCTYPE html>
<html>
<head>

<title>Quick Dice</title>

<link rel="icon" type="image/png" href="./icon192.png">
<link rel="apple-touch-icon" href="./icon192.png">

<link rel="manifest" href="./qdice.webmanifest"/>

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />



<style>



	/* global color variables */
:root {
  --red: #c32;
  --yel: #ec3;
  --grn: #284;
  --blu: #35b;

  --tan: #cba;
  --oat: #a98;
  --brn: #876;
  --drk: #222;
}

@font-face { font-family: 'Roboto-Black'; src: url('./Roboto-Black.ttf') format('truetype'); }
@font-face { font-family: 'Verdana-Bold'; src: url('./Verdana-Bold.ttf') format('truetype'); }

html, body { width: 100%; height: 100%; }

body {
  overscroll-behavior-y: contain;
  margin: 0;
  background-image: repeating-linear-gradient(-45deg, var(--oat) 0 8%, var(--tan) 0 50%);
  background-size: 12px 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: 'Verdana-Bold', sans-serif;
}

.page1 {
  position: absolute;
  xbackground-color: rgba(8, 8, 8, 0.3);
}

.dice_mat {
  position: absolute;
  background-color: var(--drk);
  border-radius: .33em;
  box-shadow: 0 0 .33em black;
  margin: 1em 0 0 1em;
}

	/* dice are set to white by defualt */
.dice {
  background-image: radial-gradient(white 70%, black 115%);
  border-radius: .12em;
  position: absolute;
  display:flex;
  align-items: center;
  justify-content: center;
  visibility: visible;
  width: 2em;
  height: 2em;
  margin: 1em 0 0 1em;
  transition: margin 0s ease-out;
}

	/* the first 2 dice remain white, the rest are colored */
.dice:nth-child(4n + 3) { background-image: radial-gradient(var(--red) 70%, black 115%); }
.dice:nth-child(4n + 4) { background-image: radial-gradient(var(--yel) 70%, black 115%); }
.dice:nth-child(4n + 5) { background-image: radial-gradient(var(--grn) 70%, black 115%); }
.dice:nth-child(4n + 6) { background-image: radial-gradient(var(--blu) 70%, black 115%); }

	/* the 4 ghost dice are transparent and start hidden */
.dice:nth-child(n + 7) {
  opacity: 0.3;
  display: none;
  visibility: inherit;
}

	/* pips start hidden and are set to black by defualt */
.dice > div { 
  position: absolute;
  background-image: radial-gradient(closest-side, black 80%, transparent);
  width: 18%;
  height: 18%;
  visibility: hidden;
}

	/* pips on the 3rd and following dice are set to white */
.dice:nth-child(n + 3) > div { background-image: radial-gradient(closest-side, white 80%, transparent); }

	/* position the 7 possible pips on the faces of the dice */
.dice div { top: 41%; left: 18%; }
.dice div:nth-child(1) { top: 18%; }
.dice div:nth-child(2) { top: 18%; left: 64%; }
.dice div:nth-child(4) { left: 41%; }
.dice div:nth-child(5) { left: 64%; }
.dice div:nth-child(6) { top: 64%; }
.dice div:nth-child(7) { top: 64%; left: 64%; }


	/* numerals start hidden and are set to black by defualt */
.numeral {
  color: black;
  font-size: 150%;
  background-color: white;

  width: 68%;
  height: 68%;
  z-index: 1;
  opacity: 0;
  display:flex;
  align-items: center;
  justify-content: center;
  transition: opacity .5s;
  font-family: 'Roboto-Black', sans-serif;
}

	/* numerals on the 3rd and following dice are set to white */
.dice:nth-child(n + 3) > span { color: white; }
.dice:nth-child(3) > span { background-color: var(--red); }
.dice:nth-child(4) > span { background-color: var(--yel); }
.dice:nth-child(5) > span { background-color: var(--grn); }
.dice:nth-child(6) > span { background-color: var(--blu); }

	/* some button features are set relative to the font size */
.buttn {
  color: var(--drk);
  font-size: 125%;
  text-shadow: 0 .03em .05em var(--tan);

  position: absolute;
  background-image: linear-gradient(var(--oat) 0, var(--brn) 100%);
  width: 1.84em;
  height: 1.84em;
  border-radius: .3em;
  border: .08em solid var(--drk);
  margin: .333em 0 0 .333em;
  text-align: center;
}

.buttn div { font-size: 40%; }

.shake:active { opacity: 0.3; }



</style>



</head>
<body oncontextmenu="return false;" onselectstart="return false;">

<!---
<span onclick="document.getElementById('page1').style.visibility = 'hidden';">hide all but dice</span>
<span onclick="document.getElementById('page1').style.visibility = 'visible';">- come back</span>
<br>
<span onclick="document.getElementById('page1').style.display = 'none';">hide all</span>
<span onclick="document.getElementById('page1').style.display = 'inline';">- come back</span>
--->

<div id="page1" class="page1">

  <div id="dice_mat" class="dice_mat">

    <div class="dice">
      <div></div><div></div><div></div><div></div><div></div><div></div><div></div>
      <span class="numeral"></span>
    </div>

    <div class="dice">
      <div></div><div></div><div></div><div></div><div></div><div></div><div></div>
      <span class="numeral"></span>
    </div>

    <div class="dice" onclick="in_out(2);">
      <div></div><div></div><div></div><div></div><div></div><div></div><div></div>
      <span class="numeral"></span>
    </div>

    <div class="dice" onclick="in_out(3);">
      <div></div><div></div><div></div><div></div><div></div><div></div><div></div>
      <span class="numeral"></span>
    </div>

    <div class="dice" onclick="in_out(4);">
      <div></div><div></div><div></div><div></div><div></div><div></div><div></div>
      <span class="numeral"></span>
    </div>

    <div class="dice" onclick="in_out(5);">
      <div></div><div></div><div></div><div></div><div></div><div></div><div></div>
      <span class="numeral"></span>
    </div>

    <div class="dice" onclick="in_out(6);"></div>
    <div class="dice" onclick="in_out(7);"></div>
    <div class="dice" onclick="in_out(8);"></div>
    <div class="dice" onclick="in_out(9);"></div>

  </div>

  <div id="shake" class="buttn shake" onclick="shaker();">
    S
    <div>
      SHAKE
    </div>
  </div>

  <div id="roll" class="buttn" style="opacity: 0.3;" onclick="roller();">
    R
    <div>
      ROLL
    </div>
  </div>

<div onclick="toggle_faces();">#</div>

</div>



<script type="text/javascript">



  var landscape;
  var jiggle = Array(12).fill(1);

  var seed = -1;  /* indicates dice not shaken yet */
  var dice_locked = 0;  /* counts the dice taken out */
  var use_numerals = 0;  /* pips are displayed by defualt */
  var shake_count = 0;



  new ResizeObserver(() => {

    draw_page1();

  }).observe(document.body);



  function draw_page1() {

	/* get objects for the dice and buttons */

    let pg = document.getElementById('page1').style;
    let mat = document.getElementById('dice_mat');
    let shake = document.getElementById('shake').style;
    let roll = document.getElementById('roll').style;

	/* determine orientation and scale from screen dimensions */

    if (window.innerHeight < window.innerWidth) {

      landscape = 1;
      if (window.innerHeight * 16 < window.innerWidth * 9) {
        pg.fontSize = window.innerHeight / 9 + 'px';
      } else {
        pg.fontSize = window.innerWidth / 16 + 'px';
      }
    } else {

      landscape = 0;
      if (window.innerHeight * 9 > window.innerWidth * 16) {
        pg.fontSize = window.innerWidth / 9 + 'px';
      } else {
        pg.fontSize = window.innerHeight / 16 + 'px';
      }
    }

	/* a page should be largest available 16x9 space */

    pg.height = (landscape ? 9 : 16) + 'em';
    pg.width = (landscape ? 16 : 9) + 'em';

	/* size the dice mat */

    mat.style.height = (landscape ? 7 : 10) + 'em';
    mat.style.width = (landscape ? 10 : 7) + 'em';

	/* buttons are placed relative to the page corner */

    shake.top = (landscape ? 3.533 : 9) + 'em';
    shake.left = (landscape ? 9 : 1) + 'em';
    roll.top = (landscape ? 1 : 9) + 'em';
    roll.left = (landscape ? 9 : 3.533) + 'em';

	/* place dice, ghost dice are under colored dice */

    for (let i = 0; i < 10; i++) {

      let x = Math.floor(i / 2) - Math.floor(i / 6) * 2;
      let y = (i + landscape) % 2;

      mat.children[i].style.top = 3 * (landscape ? y : x) + 'em';
      mat.children[i].style.left = 3 * (landscape ? x : y) + 'em';
    }

    add_jiggle(0);

  }



  function in_out(i) {

	/* up to 2 colored dice can be toggled in or out */

    if (i < 6 && (dice_locked > 1 || dice_locked < 0)) return;

    let j = (i < 6 ? 1 : -1);
    dice_locked += j;

    let mat = document.getElementById('dice_mat');
    mat.children[i].style.display = 'none';
    mat.children[i + 4 * j].style.display = 'flex';

  }



  function toggle_faces() {

    use_numerals = !use_numerals;
    for (let i = 0; i < 6; i++) {
      let d = document.getElementById('dice_mat').children[i].children[7];
      d.style.opacity = 0 + use_numerals;
    }
  }



  function shaker() {

	/* if not yet shaken, blank the dice */

    if (seed < 0) {
      for (let i = 0; i < 6; i++) {

        let d = document.getElementById('dice_mat').children[i];
        d.children[7].textContent = '';

        for (let j = 0; j < 7; j++) {
          d.children[j].style.visibility = 'hidden';
        }
      }
      seed = 0;
      document.getElementById('roll').style.opacity = 1.0;
    }

	/* each shake is added to the previous */

    shake_count++;
    let hashes = xmur3(String(Date.now() / shake_count));
    let rand = sfc32(hashes(), hashes(), hashes(), hashes());
    seed = (seed + rand()) % 1;

	/* shaking the dice jiggles them */

    for (let i = 0; i < 12; i++) {
      jiggle[i] = .55 + .9 * Math.random();
    }

    add_jiggle(.2);

  }



  function add_jiggle(anim) {

    for (let i = 0; i < 6 ; i++) {
      let d = document.getElementById('dice_mat').children[i].style;

      d.transitionDuration = anim + 's';
      d.marginTop = (landscape ? 2 - jiggle[i] : jiggle[i + 6]) + 'em';
      d.marginLeft = (landscape ? jiggle[i + 6] : jiggle[i]) + 'em';
    }

  }



  function clear_jiggle() {

    for (let i = 0; i < 6; i++) {
      document.getElementById('dice_mat').children[i].style.margin = '1em 0 0 1em';
      jiggle[i * 2] = jiggle[i * 2 + 1] = 1;
    }

  }



  function reveal_face(i, j) {

    let d = document.getElementById('dice_mat').children[i];
    d.children[7].textContent = (j + 1);

    if (j % 2 == 0) {
      d.children[3].style.visibility = 'visible';
    }
    if (j != 0) {
      d.children[1].style.visibility = 'visible';
      d.children[5].style.visibility = 'visible';
    }
    if (j > 2) {
      d.children[0].style.visibility = 'visible';
      d.children[6].style.visibility = 'visible';
    }
    if (j > 4) {
      d.children[2].style.visibility = 'visible';
      d.children[4].style.visibility = 'visible';
    }

  }



  function roller() {

	/* dice won't be rolled if not yet shaken */

    if (seed < 0) return;

	/* parse and display the rolls */

    let rolled = '00000' + Math.floor(seed * (6 ** 6)).toString(6);
    rolled = rolled.substr(rolled.length - 6);
    
    for (let i = 0; i < 6; i++) {
      reveal_face(i, parseInt(rolled.charAt(5 - i)));
    }

    clear_jiggle();

	/* disable the roll button until dice are shaken again */

    seed = -1;
    document.getElementById('roll').style.opacity = .3;

  }



/* -------------------------------------
   not my code: MurmurHash3 + sfc32 PRNG
   ------------------------------------- */


function xmur3(str) {
    for(var i = 0, h = 1779033703 ^ str.length; i < str.length; i++) {
        h = Math.imul(h ^ str.charCodeAt(i), 3432918353);
        h = h << 13 | h >>> 19;
    } return function() {
        h = Math.imul(h ^ (h >>> 16), 2246822507);
        h = Math.imul(h ^ (h >>> 13), 3266489909);
        return (h ^= h >>> 16) >>> 0;
    }
}



function sfc32(a, b, c, d) {
    return function() {
      a >>>= 0; b >>>= 0; c >>>= 0; d >>>= 0; 
      var t = (a + b) | 0;
      a = b ^ b >>> 9;
      b = c + (c << 3) | 0;
      c = (c << 21 | c >>> 11);
      d = d + 1 | 0;
      t = t + d | 0;
      c = c + t | 0;
      return (t >>> 0) / 4294967296;
    }
}



/* -------------------------------------
   register a service worker for offline
   ------------------------------------- */



if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./service-worker.js');
}



</script>
</body>
</html>
