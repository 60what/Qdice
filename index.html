<!DOCTYPE html>
<html>
<head>

<title>Quick Dice</title>

<link rel="icon" type="image/png" href="./icon192.png">
<link rel="apple-touch-icon" href="./icon192.png">

<link rel="manifest" href="./qdice.webmanifest"/>

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />



<style>



	/* global color variables */
:root {
  --red: #c32;
  --yel: #ec3;
  --grn: #284;
  --blu: #35b;

  --tan: #cba;
  --oat: #a98;
  --brn: #876;

  --prl: #eee;
  --gry: #aaa;
  --drk: #222;

  --mst: rgba(255, 255, 255, .15);
  --fog: rgba(255, 255, 255, .5);
}

@font-face { font-family: 'Roboto-Black'; src: url('./Roboto-Black.ttf') format('truetype'); }
@font-face { font-family: 'Verdana-Bold'; src: url('./Verdana-Bold.ttf') format('truetype'); }

html, body { width: 100%; height: 100%; }

body {
  margin: 0;
  display: flex;
  overflow: hidden;
  color: var(--drk);
  align-items: center;
  justify-content: center;
  background-size: 12px 12px;
  overscroll-behavior-y: contain;
  font-family: 'Roboto-Black', sans-serif;
  background-image: repeating-linear-gradient(-45deg, var(--oat) 0 8%, var(--tan) 0 50%); }

.rex {
  width: 9em;
  height: 16em;
  position: absolute; }

.dicepad {
  width: 7em;
  height: 10em;
  position: absolute;
  margin: 1em 0 0 1em;
  border-radius: .33em;
  transition: opacity .5s;
  background-color: var(--drk);
  box-shadow: 0 0 .4em -.02em black; }

.card {
  opacity: 0;
  color: var(--fog);
  position: absolute;
  width: 9em; height: 16em;
  background-color: currentColor;
  right: 50vmin; margin-right: 4.5em; }

.card.card_out { right: 0; margin-right: 0; opacity: 1; }

.bar { position: absolute; width: 1.4em; }

.tile {
  margin: .1em;
  width: 1.2em;
  height: 1.2em;
  display: flex;
  position: relative;
  border-radius: .2em;
  align-items: center;
  justify-content: center; }

.tile span {
  width: 88%;
  height: 88%;
  display: flex;
  font-size: 80%;
  border-radius: 14%;
  align-items: center;
  justify-content: center; }



.score.bar {
  height: 15.8em;
  padding: .2em 0 0 0;
  background-color: currentColor;
                      right: 2.0em; color: var(--red); }
.score:nth-child(2) { right: 3.4em; color: var(--yel); }
.score:nth-child(3) { right: 4.8em; color: var(--grn); }
.score:nth-child(4) { right: 6.2em; color: var(--blu); }

.score .tile     { background-color: var(--fog); }
.score .tile_off { background-color: var(--mst); }

.score .tile_sel { background-color: white !important; }
.score .tile_sel span { background-color: currentColor; }
.score .tile_sel span p { color: white !important; }

.lock, .lock span { border-radius: 50%; }
.lock span p { opacity: 0; }

.score.locked_bar > .tile          { background-color: var(--mst); }
.score.locked_bar > .lock.tile_off { background-color: var(--fog); }
.score.locked_bar > .tile_sel           { opacity: .7; }
.score.locked_bar > .tile:nth-child(11) { opacity: 1; }
.score.locked_bar > .lock > span > p { opacity: 1; }

.penalty.bar { top: 8em; right: 7.6em; }
.penalty .tile { color: var(--gry); background-color: currentColor; }
.penalty .tile_sel { color: var(--drk); }
.penalty .tile span { background-color: var(--prl); font-size: 38%; }
.penalty .tile span::before { content: 'PASS'; }

.points { right: 7.6em; }

.points .tile { margin: .06em .1em .06em .1em; xbackground: red;
                             color: var(--drk); }
.points .tile:nth-child(1) { color: var(--red); }
.points .tile:nth-child(2) { color: var(--yel); }
.points .tile:nth-child(3) { color: var(--grn); }
.points .tile:nth-child(4) { color: var(--blu); }
.points .tile:nth-child(5) { color: var(--gry); }

.points .tile:nth-child(6) { top: .1em; opacity: 0;
  transition: opacity .5s;
  align-items: flex-end; }

.points .tile span {
  font-size: .5em;
  width: 2.2em;
  height: 1.6em;
  border: .1em solid currentColor;
  border-radius: .4em;
  background-color: var(--prl); }

.points .tile:nth-child(6) span { height: 1.3em; margin-bottom: .15em; }

.points .tile:nth-child(6) div {
  width: 100%;
  height: 100%;
  font-size: 35%;
  position:absolute;
  text-align: center; }

.points .tile:nth-child(6) div::before { content: 'TOTAL'; }



.bigbutton {
  width: 2.3em;
  height: 2.3em;
  left: 1.667em;
  top: 11.667em;
  text-align: center;
  position: absolute;
  border-radius: .4em;
  border: .1em solid var(--drk);
  font-family: 'Verdana-Bold', sans-serif;
  text-shadow: 0 .04rem .06rem var(--tan);
  background-image: linear-gradient(var(--oat) 0, var(--brn) 100%); }

.bigbutton.card_out { font-size: .55em; top: 11.3rem; left: 7.3rem; }

.shake:active { opacity: .3; }
.roll { left: 4.833em; opacity: .3; }

.roll.card_out { top: 9.7rem; }

.bigbutton .text1 { font-size: 135%;
  position: absolute;
  width: 100%; }

.bigbutton.card_out .text1 { font-size: 173%; }

.bigbutton .text2 { font-size: .5em;
  position: absolute;
  width: 100%;
  top: 3em;
  transition: opacity .5s ; }

.bigbutton.card_out .text2 { opacity: 0; }



/* choppy sliding might be caused if:
   start and stop values are not declared?
   length unit types differ?                     ------------------------------- */

.cube { position: absolute; color: white; left: 2rem; top: 2rem; }
.cube:nth-child(3) { top: 5rem; color: var(--red); }
.cube:nth-child(4) { top: 5rem; color: var(--yel); }
.cube:nth-child(5) { top: 8rem; color: var(--grn); }
.cube:nth-child(6) { top: 8rem; color: var(--blu); }
.cube:nth-child(2n) { left: 5rem; }

.cube.card_out { left: 7.4rem; top: .5rem; font-size: .6em; }
.cube.card_out:nth-child(2) { top: 2.0rem; }
.cube.card_out:nth-child(3) { top: 3.5rem; }
.cube.card_out:nth-child(4) { top: 5.0rem; }
.cube.card_out:nth-child(5) { top: 6.5rem; }
.cube.card_out:nth-child(6) { top: 8.0rem; }


.dice {
  top: 0;
  left: 0;
  margin: 0;
  width: 2em;
  height: 2em;
  display: flex;
  position: absolute; 
  align-items: center;
  border-radius: .2em;
  justify-content: center;
  background-color: currentColor;
  background-image: radial-gradient(transparent 70%, black 130%); }

.dice:nth-child(1) { box-shadow: 0 0 .3em .1em rgba(0,0,0,.2); }
.dice:nth-child(2) { opacity: .3; display: none; }

.card_out .dice { margin: 0 !important; }

.pip, .numeral p { color: black; }
.cube:nth-child(n + 3) .pip, .cube:nth-child(n + 3) .numeral p { color: white; }

.pip {
  top: 41%;
  left: 41%;
  width: 18%; 
  height: 18%; 
  visibility: hidden;
  position: absolute;
  background-image: radial-gradient(closest-side, currentColor 80%, transparent); }

.pip.top    { top:  18%; }
.pip.bottom { top:  64%; }
.pip.left   { left: 18%; }
.pip.right  { left: 64%; }

.numeral {
  opacity: 0;
  width: 68%;
  height: 68%;
  display: flex;
  font-size: 150%;
  position: absolute;
  align-items: center;
  justify-content: center;
  transition: opacity .5s;
  background-color: currentColor; }



.shift_2s { transition: all .2s ease-out; }
.shift_5s { transition: all .5s ease-out; }



</style>



</head>
<body oncontextmenu="return false;" onselectstart="return false;"">
<div class="rex">

  <div class="dicepad"></div>
  <div class="card">
    <div class="score bar"></div>
    <div class="score bar"></div>
    <div class="score bar"></div>
    <div class="score bar"></div>
    <div class="penalty bar"></div>
    <div class="points bar"></div>
  </div>
  <div class="dice_set"></div>

  <div class="bigbutton shake" onclick="shaker();">
    <div class="text1">S</div><div class="text2">SHAKE</div>
  </div>
  <div class="bigbutton roll" onclick="roller();">
    <div class="text1">R</div><div class="text2">ROLL</div>
  </div>

  <div onclick="toggle_scorecard();" style="position: absolute; bottom: 0;">+</div>

</div>

<script type="text/javascript"> 'use strict';

let $ = (selectors) => document.querySelector(selectors);
let $id = id => document.getElementById(id);
let $all = (selectors) => document.querySelectorAll(selectors);



  var landscape = -1;	 			/* landscape unknown */
  var seed = -1;				/* indicates dice not shaken yet */
  var dice_locked = new Array(5).fill(0);	/* for dice locked by card selections */
  var use_numerals = 0;				/* pips are displayed by defualt */

  var shake_count = 0;
  var scorecard = 0; 
  var game_end = 0;

  var undo = 1;
  var consume = 0;



  window.onload = populate();



  function populate() {

    let s = $all('.score');
    for (let i = 0; i < 4; i++) {
      for (let j = 0; j < 12; j++) {
        s[i].appendChild(document.createElement('div'));
        s[i].children[j].className = 'tile' + (j == 10 ? ' tile_off' : '');
        s[i].children[j].setAttribute('onclick',`toggle_tile(${i}, ${j});`);
        s[i].children[j].appendChild(document.createElement('span'));
        s[i].children[j].children[0].appendChild(document.createElement('p'));
        s[i].children[j].children[0].children[0].innerText = (i < 2 ? j + 2 : 12 - j);
      }
      s[i].children[11].className += ' lock';
      s[i].children[11].children[0].children[0].innerText = 'X';
      s[i].children[11].setAttribute('onclick',`toggle_lock(${i}, 0);`);
    }

    let p = $('.penalty');
    for (let i = 0; i < 4; i++) {
      p.appendChild(document.createElement('div'));
      p.children[i].className = 'tile';
      p.children[i].setAttribute('onclick',`toggle_penalty(${i});`);
      p.children[i].appendChild(document.createElement('span'));
      p.children[i].children[0].appendChild(document.createElement('p'));
    }

    let t = $('.points');
    for (let i = 0; i < 6; i++) {
      t.appendChild(document.createElement('div'));
      t.children[i].className = 'tile';
      t.children[i].appendChild(document.createElement('span'));
      t.children[i].children[0].innerText = (i < 4 ? '+ 0' : '- 0');
    }
      t.children[5].appendChild(document.createElement('div'));


    /*--------------------------------------------------------
    - The dice set contains 6 cubes, and each cube contains 1 or 2 dice.
    - The last 4 cubes are given 2 dice, since colored dice have a shadow element.
    - The first 2 cubes contain 1 dice each that toggle numeral faces on click.
    - The first dice of each cube contains 7 pips and then a numeral.
    - The pips are given positions on the dice derived from an index count. */


    let d = $('.dice_set');
    for (let i = 0; i < 6; i++) {
      d.appendChild(document.createElement('div'));
      d.children[i].className = 'cube';

      for (let j = 0; j * 4 < i + 3; j++) {
        d.children[i].appendChild(document.createElement('div'));
        d.children[i].children[j].className = 'dice';
        d.children[i].children[j].setAttribute('onclick',`in_out(${(i - 1) * (j ? -1 : 1)}, 0);`);
        if (i < 2) d.children[i].children[j].setAttribute('onclick','toggle_faces();');
      }
      for (let j = 0; j < 7; j++) {
        d.children[i].children[0].appendChild(document.createElement('div'));
        let pip = `pip${j < 2 ? ' top' : ''}${j > 4 ? ' bottom' : ''}`;
        pip += `${!(j % 2.5 % 2) ? ' left' : ''}${j % 5 % 3 % 2 ? ' right' : ''}`;
        d.children[i].children[0].children[j].className = pip;
      }
      d.children[i].children[0].appendChild(document.createElement('span'));
      d.children[i].children[0].children[7].className = 'numeral';
      d.children[i].children[0].children[7].appendChild(document.createElement('p'));
    }

  }



  new ResizeObserver(() => {

    stretch_to_fit();

  }).observe(document.body);



  function stretch_to_fit() {

    let grit = document.documentElement.style;
    let prior = landscape;

    landscape = Math.floor(window.innerWidth / window.innerHeight);
    if (landscape) {
      grit.fontSize = `${Math.min(window.innerHeight / 9, window.innerWidth / 16)}px`;
    } else {
      grit.fontSize = `${Math.min(window.innerHeight / 16, window.innerWidth / 9)}px`;
    }

    remove_animations();

    if (landscape != prior) {
      $('.rex').style.transform = `rotate(${ landscape ? -90 : 0 }deg)`;
      let flip = $all('.dice, .bigbutton, .tile');
      flip.forEach(e => { e.style.transform = `rotate(${ landscape ? 90 : 0 }deg)`; });
    }

  }



  function remove_animations() {

    $all('.shift_2s, .shift_5s').forEach(e => {
      e.classList.remove('shift_2s', 'shift_5s');
    });

  }



  function in_out(i, source) {

    if (i > 0 && game_end) return;
    if (i < 0 && (dice_locked[4]) || dice_locked[-1 - i]) return;

    let d = $('.dice_set').children[1 + Math.abs(i)];
    d.children[(i > 0 ? 0 : 1)].style.display = 'none';
    d.children[(i > 0 ? 1 : 0)].style.display = 'flex';

    if (source < 1) toggle_lock((Math.abs(i) - 1), 2);

  }



  function toggle_faces() {
    use_numerals = 1 - use_numerals;
    let d = $all('.numeral');
    d.forEach(i => { i.style.opacity = use_numerals; });
  }



  function toggle_scorecard() {

    remove_animations();

    let e = $all('.card, .cube, .dice, .bigbutton, .text1');

    e.forEach(i => { i.classList.add('shift_5s'); });

    if (scorecard) {
      e.forEach(i => { i.classList.remove('card_out'); });
    } else {
      e.forEach(i => { i.classList.add('card_out'); });
    }

    $('.dicepad').style.opacity = scorecard;
    scorecard = 1 - scorecard;

  }



  function toggle_tile(bar, tile) {

    if (dice_locked[4]) return;

    let b = $('.card').children[bar];
    let t = b.children[tile].classList;

    if (b.classList.contains('locked_bar') && (tile < 10 || !t.contains('tile_sel'))) return;
    if (t.contains('tile_off')) return;
    if (t.contains('tile_sel') && undo < 1) return;

    if (tile > 9) { dice_locked[bar] = !dice_locked[bar]; toggle_lock(bar, 1); }

    if (t.contains('tile_sel')) {

      t.remove('tile_sel'); undo -= consume;

      while (tile > 0) {
        tile--; b.children[tile].classList.remove('tile_off');
        if (b.children[tile].classList.contains('tile_sel')) tile = 0;
      }

      if (b.querySelectorAll('.tile_sel').length < 5) {
        b.children[10].classList.add('tile_off');
      }
    } else {

      t.add('tile_sel');

      while (tile > 0) {
        tile--; b.children[tile].classList.add('tile_off');
        if (b.children[tile].classList.contains('tile_sel')) tile = 0;
      }

      if (b.querySelectorAll('.tile_sel').length > 4) {
        b.children[10].classList.remove('tile_off');
      }
    }

  update_points();
  }



  function toggle_lock(bar, source) {

    let c = $('.card');
    let s = c.children[bar].children[11].classList;

    if (c.children[bar].classList.contains('locked_bar') && !s.contains('tile_off')) return;
    if (s.contains('tile_off') && undo < 1 && source < 2) return;
    if (s.contains('tile_sel') && !source) return;

    if (s.contains('tile_off')) {

      s.remove('tile_off', 'tile_sel');

      game_end = 0; if (!source) undo -= consume;
      if (source < 2) in_out(-1 - bar, 1);

      for (let j = 0; j < 5; j++) {
        if (!c.children[j].lastChild.classList.contains('tile_off')) {
          c.children[j].classList.remove('locked_bar');
        }
      }
    } else {

      s.add('tile_off'); if (source == 1) s.add('tile_sel');
      if (source < 2) in_out(bar + 1, 1);
      c.children[bar].classList.add('locked_bar');

      if ($all('.locked_bar').length > 1) {
        game_end = 1;
        for (let j = 0; j < 5; j++) c.children[j].classList.add('locked_bar');
      }
    }

  update_points();
  }



  function toggle_penalty(i) {

    let p = $('.penalty');
    let c = $('.card');

    if (p.classList.contains('locked_bar')) return;
    if (p.children[i].classList.contains('tile_sel') && undo < 1) return;

    let k = p.querySelectorAll('.tile_sel').length;

    if (p.children[i].classList.contains('tile_sel')) {

      p.children[k - 1].classList.remove('tile_sel');
      dice_locked[4] = game_end = 0; undo -= consume;

      for (let j = 0; j < 4; j++) {
        if (!c.children[j].lastChild.classList.contains('tile_off')) {
          c.children[j].classList.remove('locked_bar');
        }
      }
    } else {

      p.children[k].classList.add('tile_sel');

      if (k > 2) {
        dice_locked[4] = game_end = 1;
        for (let j = 0; j < 4; j++) c.children[j].classList.add('locked_bar');
      }
    }

  update_points();
  }



  function update_points() {

    let c = $('.card');
    let p = $('.points');

    let s = -5 * c.children[4].querySelectorAll('.tile_sel').length;
    p.children[4].children[0].textContent = `- ${s * -1}`;

    for (let j = 0; j < 4; j++) {
      let k = c.children[j].querySelectorAll('.tile_sel').length;
      let r = 0; while (k > 0) r += k--;
      p.children[j].children[0].textContent = `+ ${r}`; s += r;
    }

    p.children[5].children[0].textContent = s;

    p.children[5].style.opacity = game_end;

  }



  function shaker() {

	/* if not yet shaken, blank the dice */

    if (seed < 0) {

      $all('.numeral p').forEach(e => { e.textContent = ''; });
      $all('.pip').forEach(e => { e.style.visibility = 'hidden'; });

      $('.roll').style.opacity = 1;
      seed = 0;
    }

	/* each shake is added to the previous */

    shake_count++;
    let hashes = xmur3(String(Date.now() / shake_count));
    let rand = sfc32(hashes(), hashes(), hashes(), hashes());
    seed = (seed + rand()) % 1;

	/* shaking the dice jiggles them */

    jiggle();

  }



  function jiggle() {

    remove_animations();

    $all('.dice:nth-child(1)').forEach(e => {
      e.classList.add('shift_2s');
      e.style.top = `${.45 * (Math.random() - .5)}em`;
      e.style.left = `${.9 * (Math.random() - .5)}em`;
      e.style.marginTop = `${e.style.top}`;
    });

  }



  function reveal_face(i, j) {

    let d = $('.dice_set').children[i].children[0];
    d.children[7].children[0].textContent = (j + 1);

    if (j % 2 == 0) {
      d.children[3].style.visibility = 'visible';
    }
    if (j != 0) {
      d.children[1].style.visibility = 'visible';
      d.children[5].style.visibility = 'visible';
    }
    if (j > 2) {
      d.children[0].style.visibility = 'visible';
      d.children[6].style.visibility = 'visible';
    }
    if (j > 4) {
      d.children[2].style.visibility = 'visible';
      d.children[4].style.visibility = 'visible';
    }

  }



  function roller() {

    if (seed < 0) return;

    let rolled = Math.floor(seed * (6 ** 6)).toString(6).padStart(6, '0');

    remove_animations();

    let d = $all('.dice:nth-child(1)');
    for (let i = 0; i < 6; i++) {
      reveal_face(i, parseInt(rolled.charAt(5 - i)));
      d[i].classList.add('shift_2s');
      d[i].style.top = d[i].style.left = d[i].style.margin = '0';
    }

    $('.roll').style.opacity = .3;
    seed = -1;

  }



/* -------------------------------------
   not my code: MurmurHash3 + sfc32 PRNG
   ------------------------------------- */



function xmur3(str) {
    for(var i = 0, h = 1779033703 ^ str.length; i < str.length; i++) {
        h = Math.imul(h ^ str.charCodeAt(i), 3432918353);
        h = h << 13 | h >>> 19;
    } return function() {
        h = Math.imul(h ^ (h >>> 16), 2246822507);
        h = Math.imul(h ^ (h >>> 13), 3266489909);
        return (h ^= h >>> 16) >>> 0;
    }
}



function sfc32(a, b, c, d) {
    return function() {
      a >>>= 0; b >>>= 0; c >>>= 0; d >>>= 0; 
      var t = (a + b) | 0;
      a = b ^ b >>> 9;
      b = c + (c << 3) | 0;
      c = (c << 21 | c >>> 11);
      d = d + 1 | 0;
      t = t + d | 0;
      c = c + t | 0;
      return (t >>> 0) / 4294967296;
    }
}



/* -------------------------------------
   register a service worker for offline
   ------------------------------------- */



if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./service-worker.js');
}



</script>
</body>
</html>
