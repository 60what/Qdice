<!DOCTYPE html>
<html>
<head>

<title>Quick Dice</title>

<link rel="icon" type="image/png" href="./icon192.png">
<link rel="apple-touch-icon" href="./icon192.png">

<link rel="manifest" href="./qdice.webmanifest"/>

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />



<style>



	/* global color variables */
:root {
  --red: #c32;
  --yel: #ec3;
  --grn: #284;
  --blu: #35b;

  --tan: #cba;
  --oat: #a98;
  --brn: #876;

  --prl: #eee;
  --gry: #999;
  --drk: #222;

  --mst: rgba(255, 255, 255, .15);
  --fog: rgba(255, 255, 255, .5);
}

@font-face { font-family: 'Roboto-Black'; src: url('./Roboto-Black.ttf') format('truetype'); }
@font-face { font-family: 'Verdana-Bold'; src: url('./Verdana-Bold.ttf') format('truetype'); }

html, body { width: 100%; height: 100%; }

body {
  overscroll-behavior-y: contain;
  overflow: hidden;
  margin: 0;
  background-image: repeating-linear-gradient(-45deg, var(--oat) 0 8%, var(--tan) 0 50%);
  background-size: 12px 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: 'Roboto-Black', sans-serif;
  color: var(--drk);
}

#rex {
  position: absolute;
  width: 9rem;
  height: 16rem;
  transform-origin: 4.5rem 8rem;
}


	/* ------------------------------------------------------------- */
	/* scorecard starts left of the screen with a sliding transition */

.card {
  color: var(--fog);
  position: absolute;
  width: 9em; height: 16em;
  right: 50vmin; margin-right: 4.5em;  /* left edge of the screen */
  opacity: 0;
  background-color: currentColor;
}

.card_out { right: 0; margin-right: 0; opacity: 1; }

.bar { width: 1.4em; position: absolute; background-color: currentColor; }

.tile {
  position: relative;
  width: 1.2em; height: 1.2em; margin: .1em;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: .2em;
}

.tile > span {
  font-size: 80%;
  width: 88%; height: 88%;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 14%;
}



.score.bar { height: 15.8em; padding: .2em 0 0 0;
                          right: 2.0em; color: var(--red); }
.score.bar:nth-child(2) { right: 3.4em; color: var(--yel); }
.score.bar:nth-child(3) { right: 4.8em; color: var(--grn); }
.score.bar:nth-child(4) { right: 6.2em; color: var(--blu); }

.score > .tile     { background-color: var(--fog); }
.score > .tile_off { background-color: var(--mst); }

.score > .tile_sel { background-color: white !important; }
.score > .tile_sel > span { background-color: currentColor; }
.score > .tile_sel > span > span { color: white !important; }

.lock, .lock > span { border-radius: 50%; }
.lock > span > span { opacity: 0; }

.score.locked_bar > .tile          { background-color: var(--mst); }
.score.locked_bar > .lock.tile_off { background-color: var(--fog); }
.score.locked_bar > .tile_sel           { opacity: .7; }
.score.locked_bar > .tile:nth-child(11) { opacity: 1; }
.score.locked_bar > .lock > span > span { opacity: 1; }



#penalty { top: 9.3em; right: 7.6em; color: transparent; }
#penalty > .tile { color: var(--gry); background-color: currentColor; }
#penalty > .tile > span { background-color: var(--prl); font-size: 38%; }
#penalty > .tile_sel { color: var(--drk); }



#points { right: 7.6em; color: transparent; }

#points > .tile { margin: .06em .1em .06em .1em;
                               color: var(--drk); }
#points > .tile:nth-child(1) { color: var(--red); }
#points > .tile:nth-child(2) { color: var(--yel); }
#points > .tile:nth-child(3) { color: var(--grn); }
#points > .tile:nth-child(4) { color: var(--blu); }
#points > .tile:nth-child(5) { color: var(--gry); }

#points > .tile > span {
  font-size: .5em;
  width: 2.2em; height: 1.6em;
  border: .1em solid currentColor;
  border-radius: .4em;
  background-color: var(--prl);
}

#points > .tile:nth-child(6) > span {
  font-size: .3em;
  text-align: center;
  border: 0;
  background: none;
}

#points > .tile:nth-child(n + 6) { opacity: 0; transition: opacity .5s; }



	/* ------------------------------------------------------------- */

#dicepad {
  transition: opacity .5s;
  position: absolute;
  width: 7em;
  height: 10em;
  margin: 1em 0 0 1em;

  background-color: var(--drk);
  border-radius: .33em;
  box-shadow: 0 0 .4em -.02em black;
}

.bigbutton {
  font-family: 'Verdana-Bold', sans-serif;
  font-size: 1.25em;

  position: absolute;
  width: 1.84em;
  height: 1.84em;
  border: .08em solid var(--drk);
  margin: 9.333em 0 0 .333em;
  left: 1em; top: 0;

  background-image: linear-gradient(var(--oat) 0, var(--brn) 100%);
  border-radius: .3em;
  text-shadow: 0 .03em .05em var(--tan);
  text-align: center;
}

.bigbutton > div { font-size: 40%; }

#roll { left: 3.533em; opacity: 0.3; }
#shake:active { opacity: 0.3; }

.bigbutton.oncard { font-size: .6em; margin: 0; left: 12.5em !important; top: 24.5em; z-index: 1; }
#roll.oncard { top: 22.2em; }

#dice_set { color: white; }

.cube {
  position: absolute;
  top: 2em;
  left: 2em;
}

.cube:nth-child(2n + 2) { left: 5em; }
.cube:nth-child(3) { top: 5em; color: var(--red); }
.cube:nth-child(4) { top: 5em; color: var(--yel); }
.cube:nth-child(5) { top: 8em; color: var(--grn); }
.cube:nth-child(6) { top: 8em; color: var(--blu); }

.dice {
  position: absolute;
  width: 2em;
  height: 2em;

  display:flex;
  align-items: center;
  justify-content: center;
  background-color: currentColor;
  background-image: radial-gradient(transparent 70%, black 130%);
  border-radius: .2em;
}

.cube > .dice:nth-child(1) { opacity: .3; display: none; }

	/* pips start hidden and are set to black by defualt */
.dice > div { 
  position: absolute;
  background-image: radial-gradient(closest-side, black 80%, transparent);
  width: 18%;
  height: 18%;
  visibility: hidden;
}

	/* position the 7 possible pips on the faces of the dice */
.dice div { top: 41%; left: 18%; }
.dice div:nth-child(1) { top: 18%; }
.dice div:nth-child(2) { top: 18%; left: 64%; }
.dice div:nth-child(4) { left: 41%; }
.dice div:nth-child(5) { left: 64%; }
.dice div:nth-child(6) { top: 64%; }
.dice div:nth-child(7) { top: 64%; left: 64%; }


	/* pips on the 3rd and following dice are set to white */
.cube:nth-child(n + 3) > div > div { background-image: radial-gradient(closest-side, white 80%, transparent); }

	/* numerals start hidden and are set to black by default */
.numeral {

  font-size: 1.5em;
  background-color: currentColor;

  width: 68%;
  height: 68%;
  z-index: 1;
  opacity: 0;
  margin: auto;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: opacity .5s;
}

.cube:nth-child(n) > div > span > span { color: black; }
.cube:nth-child(n + 3) > div > span > span { color: white; }

.cube.oncard { font-size: .65em;
              left: 11.3em; top: 5.5em; }
.cube.oncard:nth-child(2) { top: 8em; }
.cube.oncard:nth-child(3) { top: 10.5em; }
.cube.oncard:nth-child(4) { top: 13em; }
.cube.oncard:nth-child(5) { top: 15.5em; }
.cube.oncard:nth-child(6) { top: 18em; }
.cube.oncard > .dice:nth-child(2) { margin: 0 !important;
  box-shadow: 0 0 .3em .1em rgba(0,0,0,.2); }



.shift2s { transition: all .2s ease-out; }
.shift5s { transition: all .5s ease-out; }



</style>



</head>
<body oncontextmenu="return false;" onselectstart="return false;"">
<div id="rex">

  <div id="dicepad"></div>
    
  <div id="shake" class="bigbutton" onclick="shaker();">
    S<div>SHAKE</div>
  </div>
  <div id="roll" class="bigbutton" onclick="roller();">
    R<div>ROLL</div>
  </div>

  <div onclick="toggle_scorecard();" style="position: absolute; bottom: 0; z-index: 1; visibility: visible;">+</div>
  <div onclick="toggle_faces();" style="position: absolute; top: 0; right: 0; z-index: 1; visibility: visible;">#</div>

  <div id="card" class="card">
    <div class="score bar"></div>
    <div class="score bar"></div>
    <div class="score bar"></div>
    <div class="score bar"></div>
    <div id="penalty" class="bar"></div>
    <div id="points" class="bar"></div>
  </div>

  <div id="dice_set" class="dicetray" style="position: absolute;">
    <div class="cube"><div class="dice"></div>
      <div class="dice">
        <div></div><div></div><div></div><div></div><div></div><div></div><div></div>
        <span class="numeral"><span></span></span>
      </div>
    </div>
    <div class="cube"><div class="dice"></div>
      <div class="dice">
        <div></div><div></div><div></div><div></div><div></div><div></div><div></div>
        <span class="numeral"><span></span></span>
      </div>
    </div>
    <div class="cube"><div class="dice" onclick="in_out(-1, 0);"></div>
      <div class="dice" onclick="in_out(1, 0);">
        <div></div><div></div><div></div><div></div><div></div><div></div><div></div>
        <span class="numeral"><span></span></span>
      </div>
    </div>
    <div class="cube"><div class="dice" onclick="in_out(-2, 0);"></div>
      <div class="dice" onclick="in_out(2, 0);">
        <div></div><div></div><div></div><div></div><div></div><div></div><div></div>
        <span class="numeral"><span></span></span>
      </div>
    </div>
    <div class="cube"><div class="dice" onclick="in_out(-3, 0);"></div>
      <div class="dice" onclick="in_out(3, 0);">
        <div></div><div></div><div></div><div></div><div></div><div></div><div></div>
        <span class="numeral"><span></span></span>
      </div>
    </div>
    <div class="cube"><div class="dice" onclick="in_out(-4, 0);"></div>
      <div class="dice" onclick="in_out(4, 0);">
        <div></div><div></div><div></div><div></div><div></div><div></div><div></div>
        <span class="numeral"><span></span></span>
      </div>
    </div>
  </div>

</div>

<script type="text/javascript"> 'use strict';

let $id = id => document.getElementById(id);
let $all = (selectors) => document.querySelectorAll(selectors);



  var landscape = -1;	 			/* landscape unknown */
  var seed = -1;				/* indicates dice not shaken yet */
  var dice_locked = new Array(5).fill(0);	/* for dice locked by card selections */
  var use_numerals = 0;				/* pips are displayed by defualt */

  var shake_count = 0;
  var scorecard = 0; 
  var game_end = 0;

  var undo = 1;
  var consume = 0;



  window.onload = populate();



  function populate() {

    let s = $all('.score');
    for (let i = 0; i < 4; i++) {
      for (let j = 0; j < 12; j++) {
        s[i].appendChild(document.createElement('div'));
        s[i].children[j].className = 'tile' + (j == 10 ? ' tile_off' : '');
        s[i].children[j].setAttribute('onclick',`toggle_tile(${i}, ${j});`);
        s[i].children[j].appendChild(document.createElement('span'));
        s[i].children[j].children[0].appendChild(document.createElement('span'));
        s[i].children[j].children[0].children[0].innerText = (i < 2 ? j + 2 : 12 - j);
      }
      s[i].children[11].className += ' lock';
      s[i].children[11].children[0].children[0].innerText = 'X';
      s[i].children[11].setAttribute('onclick',`toggle_lock(${i}, 0);`);
    }

    let p = $id('penalty');
    for (let i = 0; i < 4; i++) {
      p.appendChild(document.createElement('div'));
      p.children[i].className = 'tile';
      p.children[i].setAttribute('onclick',`toggle_penalty(${i});`);
      p.children[i].appendChild(document.createElement('span'));
      p.children[i].children[0].appendChild(document.createElement('span'));
      p.children[i].children[0].children[0].innerText = 'PASS';
    }

    let t = $id('points');
    for (let i = 0; i < 7; i++) {
      t.appendChild(document.createElement('div'));
      t.children[i].className = 'tile';
      t.children[i].appendChild(document.createElement('span'));
      t.children[i].children[0].innerText = (i < 4 ? '+ 0' : i < 5 ? '- 0' : 'TOTAL SCORE:');
    }

  }



  new ResizeObserver(() => {

    stretch_to_fit();

  }).observe(document.body);



  function stretch_to_fit() {

    let grit = document.documentElement.style;
    let prior = landscape;

    landscape = Math.floor(window.innerWidth / window.innerHeight);
    if (landscape) {
      grit.fontSize = `${Math.min(window.innerHeight / 9, window.innerWidth / 16)}px`;
    } else {
      grit.fontSize = `${Math.min(window.innerHeight / 16, window.innerWidth / 9)}px`;
    }

    remove_animations();

    if (landscape != prior) {
      $id('rex').style.transform = `rotate(${ landscape ? -90 : 0 }deg)`;
      let flip = $all('.dice, .bigbutton, .tile');
      flip.forEach(e => { e.style.transform = `rotate(${ landscape ? 90 : 0 }deg)`; });
    }

  }



  function remove_animations() {

    $all('.shift2s, .shift5s').forEach(e => {
      e.classList.remove('shift2s', 'shift5s');
    });

  }



  function in_out(i, source) {

    if (i > 0 && game_end) return;
    if (i < 0 && (dice_locked[4]) || dice_locked[-1 - i]) return;

    let j = (i > 0 ? 1 : -1);
    let d = $id('dice_set');
    d.children[i * j + 1].children[(1 - j) / 2].style.display = 'flex';
    d.children[i * j + 1].children[(1 + j) / 2].style.display = 'none';

    if (source < 1) toggle_lock((i * j - 1), 2);

  }



  function toggle_faces() {
    use_numerals = 1 - use_numerals;
    let d = $all('.numeral');
    d.forEach(i => { i.style.opacity = use_numerals; });
  }



  function toggle_scorecard() {

    remove_animations();

    let c = $id('card');
    let d = $all('.cube, .bigbutton');

    c.classList.add('shift5s');
    d.forEach(e => { e.classList.add('shift5s'); });

    if (scorecard) {
      c.classList.remove('card_out');
      d.forEach(e => { e.classList.remove('oncard'); });
    } else {
      c.classList.add('card_out');
      d.forEach(e => { e.classList.add('oncard'); });
    }

    $id('dicepad').style.opacity = scorecard;
    scorecard = 1 - scorecard;

  }



  function toggle_tile(bar, tile) {

    if (dice_locked[4]) return;

    let b = $id('card').children[bar];
    let t = b.children[tile].classList;

    if (b.classList.contains('locked_bar') && (tile < 10 || !t.contains('tile_sel'))) return;
    if (t.contains('tile_off')) return;
    if (t.contains('tile_sel') && undo < 1) return;

    if (tile > 9) { dice_locked[bar] = !dice_locked[bar]; toggle_lock(bar, 1); }

    if (t.contains('tile_sel')) {

      t.remove('tile_sel'); undo -= consume;

      while (tile > 0) {
        tile--; b.children[tile].classList.remove('tile_off');
        if (b.children[tile].classList.contains('tile_sel')) tile = 0;
      }

      if (b.querySelectorAll('.tile_sel').length < 5) {
        b.children[10].classList.add('tile_off');
      }
    } else {

      t.add('tile_sel');

      while (tile > 0) {
        tile--; b.children[tile].classList.add('tile_off');
        if (b.children[tile].classList.contains('tile_sel')) tile = 0;
      }

      if (b.querySelectorAll('.tile_sel').length > 4) {
        b.children[10].classList.remove('tile_off');
      }
    }

  update_points();
  }



  function toggle_lock(bar, source) {

    let c = $id('card');
    let s = c.children[bar].children[11].classList;

    if (c.children[bar].classList.contains('locked_bar') && !s.contains('tile_off')) return;
    if (s.contains('tile_off') && undo < 1 && source < 2) return;
    if (s.contains('tile_sel') && !source) return;

    if (s.contains('tile_off')) {

      s.remove('tile_off', 'tile_sel');

      game_end = 0; if (!source) undo -= consume;
      if (source < 2) in_out(-1 - bar, 1);

      for (let j = 0; j < 5; j++) {
        if (!c.children[j].lastChild.classList.contains('tile_off')) {
          c.children[j].classList.remove('locked_bar');
        }
      }
    } else {

      s.add('tile_off'); if (source == 1) s.add('tile_sel');
      if (source < 2) in_out(bar + 1, 1);
      c.children[bar].classList.add('locked_bar');

      if ($all('.locked_bar').length > 1) {
        game_end = 1;
        for (let j = 0; j < 5; j++) c.children[j].classList.add('locked_bar');
      }
    }

  update_points();
  }



  function toggle_penalty(i) {

    let p = $id('penalty');
    let c = $id('card');

    if (p.classList.contains('locked_bar')) return;
    if (p.children[i].classList.contains('tile_sel') && undo < 1) return;

    let k = p.querySelectorAll('.tile_sel').length;

    if (p.children[i].classList.contains('tile_sel')) {

      p.children[k - 1].classList.remove('tile_sel');
      dice_locked[4] = game_end = 0; undo -= consume;

      for (let j = 0; j < 4; j++) {
        if (!c.children[j].lastChild.classList.contains('tile_off')) {
          c.children[j].classList.remove('locked_bar');
        }
      }
    } else {

      p.children[k].classList.add('tile_sel');

      if (k > 2) {
        dice_locked[4] = game_end = 1;
        for (let j = 0; j < 4; j++) c.children[j].classList.add('locked_bar');
      }
    }

  update_points();
  }



  function update_points() {

    let c = $id('card');
    let p = $id('points');

    let i = -5 * c.children[4].querySelectorAll('.tile_sel').length;
    p.children[4].children[0].textContent = `- ${i * -1}`;

    for (let j = 0; j < 4; j++) {
      let k = c.children[j].querySelectorAll('.tile_sel').length;
      let r = 0; while (k > 0) r += k--;
      p.children[j].children[0].textContent = `+ ${r}`; i += r;
    }

    p.children[6].children[0].textContent = i;

    p.children[5].style.opacity = p.children[6].style.opacity = game_end;

  }



  function shaker() {

	/* if not yet shaken, blank the dice */

    if (seed < 0) {
      for (let i = 0; i < 6; i++) {

        let d = $id('dice_set').children[i].children[1];
        d.children[7].children[0].textContent = '';

        for (let j = 0; j < 7; j++) {
          d.children[j].style.visibility = 'hidden';
        }
      }
      seed = 0;
      $id('roll').style.opacity = 1.0;
    }

	/* each shake is added to the previous */

    shake_count++;
    let hashes = xmur3(String(Date.now() / shake_count));
    let rand = sfc32(hashes(), hashes(), hashes(), hashes());
    seed = (seed + rand()) % 1;

	/* shaking the dice jiggles them */

    jiggle();

  }



  function jiggle() {

    $all('.dice:nth-child(2)').forEach(e => {
      e.classList.add('shift2s');
      e.style.top = `${.45 * (Math.random() - .5)}em`;
      e.style.left = `${.45 * (Math.random() - .5)}em`;
      e.style.margin = `${e.style.top} 0 0 ${e.style.left}`;
    });

  }



  function reveal_face(i, j) {

    let d = $id('dice_set').children[i].children[1];
    d.children[7].children[0].textContent = (j + 1);

    if (j % 2 == 0) {
      d.children[3].style.visibility = 'visible';
    }
    if (j != 0) {
      d.children[1].style.visibility = 'visible';
      d.children[5].style.visibility = 'visible';
    }
    if (j > 2) {
      d.children[0].style.visibility = 'visible';
      d.children[6].style.visibility = 'visible';
    }
    if (j > 4) {
      d.children[2].style.visibility = 'visible';
      d.children[4].style.visibility = 'visible';
    }

  }



  function roller() {

    if (seed < 0) return;

    let rolled = Math.floor(seed * (6 ** 6)).toString(6).padStart(6, '0');

    let d = $all('.dice:nth-child(2)');
    for (let i = 0; i < 6; i++) {
      reveal_face(i, parseInt(rolled.charAt(5 - i)));
      d[i].classList.add('shift2s');
      d[i].style.top = d[i].style.left = d[i].style.margin = '0';
    }

    $id('roll').style.opacity = .3;
    seed = -1;

  }



/* -------------------------------------
   not my code: MurmurHash3 + sfc32 PRNG
   ------------------------------------- */



function xmur3(str) {
    for(var i = 0, h = 1779033703 ^ str.length; i < str.length; i++) {
        h = Math.imul(h ^ str.charCodeAt(i), 3432918353);
        h = h << 13 | h >>> 19;
    } return function() {
        h = Math.imul(h ^ (h >>> 16), 2246822507);
        h = Math.imul(h ^ (h >>> 13), 3266489909);
        return (h ^= h >>> 16) >>> 0;
    }
}



function sfc32(a, b, c, d) {
    return function() {
      a >>>= 0; b >>>= 0; c >>>= 0; d >>>= 0; 
      var t = (a + b) | 0;
      a = b ^ b >>> 9;
      b = c + (c << 3) | 0;
      c = (c << 21 | c >>> 11);
      d = d + 1 | 0;
      t = t + d | 0;
      c = c + t | 0;
      return (t >>> 0) / 4294967296;
    }
}



/* -------------------------------------
   register a service worker for offline
   ------------------------------------- */



if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./service-worker.js');
}



</script>
</body>
</html>
